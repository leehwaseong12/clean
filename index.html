<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <title>í´ë¦°í•œ ì‚¬ëŒë“¤</title>

  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>

  <style>
    * { margin:0; padding:0; box-sizing:border-box; -webkit-tap-highlight-color:transparent; }
    :root{
      --primary:#2d2d2d; --primary-dark:#1a1a1a; --secondary:#3a3a3a;
      --bg:#0a0a0a; --card:#1a1a1a;
      --text:#ffffff; --text-light:#b0b0b0; --border:#333333;
      --success:#4CAF50; --warning:#FFA726; --danger:#EF5350;
    }
    body{
      font-family:'Noto Sans KR',sans-serif;
      background:var(--bg); color:var(--text);
      line-height:1.5; font-size:15px; overflow-x:hidden; touch-action:pan-y;
    }

    .home-screen{
      min-height:100vh;
      background:linear-gradient(135deg,#1a1a1a 0%,#2d2d2d 100%);
      display:flex; flex-direction:column; align-items:center; justify-content:center;
      padding:20px;
    }
    .logo-text{ font-size:clamp(32px,8vw,48px); font-weight:800; letter-spacing:-2px; margin-bottom:8px; text-align:center; }
    .logo-subtitle{ font-size:clamp(12px,3vw,14px); color:rgba(255,255,255,.7); letter-spacing:2px; text-align:center; margin-bottom:60px; }
    .menu-grid{ display:grid; grid-template-columns:repeat(2,1fr); gap:20px; max-width:400px; width:100%; }
    .menu-item{
      background:rgba(255,255,255,.1); backdrop-filter:blur(10px);
      border-radius:16px; padding:clamp(20px,5vw,30px) 20px;
      text-align:center; cursor:pointer; transition:all .3s;
      border:1px solid rgba(255,255,255,.1);
    }
    .menu-item:active{ transform:translateY(-5px); background:rgba(255,255,255,.15); }
    .menu-icon{ font-size:clamp(36px,10vw,48px); margin-bottom:12px; }
    .menu-title{ font-size:clamp(14px,3.5vw,16px); font-weight:700; }

    .app-container{ display:none; min-height:100vh; }
    .app-container.active{ display:block; }

    .header{
      background:linear-gradient(135deg,var(--primary) 0%,#0052CC 100%);
      color:#fff; padding:20px 16px; position:sticky; top:0; z-index:100;
      display:flex; align-items:center; gap:12px;
    }
    .back-btn{ background:none; border:none; color:#fff; font-size:24px; cursor:pointer; padding:8px; }
    .header h1{ font-size:clamp(18px,4.5vw,20px); font-weight:700; }
    .container{ padding:16px; padding-bottom:110px; }

    .section{ background:#fff; border-radius:12px; padding:20px; margin-bottom:16px; }
    .section-title{
      font-size:16px; font-weight:700; margin-bottom:16px; color:var(--bg);
      padding-bottom:12px; border-bottom:2px solid var(--bg);
    }

    .form-group{ margin-bottom:16px; }
    .form-label{ display:block; font-size:14px; font-weight:600; margin-bottom:8px; color:var(--bg); }
    .form-input{
      width:100%; padding:14px; border:1px solid #ddd; border-radius:8px;
      font-size:16px; font-family:'Noto Sans KR',sans-serif;
    }
    textarea.form-input{ min-height:100px; resize:vertical; }

    .type-selector{ display:flex; flex-direction:column; gap:16px; margin-bottom:20px; }
    .type-btn{
      padding:24px; border:none; border-radius:16px;
      background:linear-gradient(135deg,#fff 0%,#f5f5f5 100%);
      cursor:pointer; transition:all .3s; font-weight:600; font-size:18px; color:var(--bg);
      box-shadow:0 4px 12px rgba(0,0,0,.1);
      display:flex; align-items:center; gap:16px; text-align:left;
    }
    .type-btn:active{ transform:translateY(-2px) scale(.98); box-shadow:0 6px 20px rgba(0,0,0,.15); }
    .type-btn .icon{
      font-size:48px; width:64px; height:64px;
      background:linear-gradient(135deg,var(--primary),var(--secondary));
      border-radius:12px; display:flex; align-items:center; justify-content:center; flex-shrink:0;
    }
    .type-btn .content{ flex:1; }
    .type-btn .title{ font-size:18px; font-weight:700; margin-bottom:4px; color:var(--bg); }
    .type-btn .desc{ font-size:14px; color:#666; font-weight:400; }
    .type-btn .arrow{ font-size:24px; color:#999; }

    .photo-grid{ display:grid; grid-template-columns:repeat(auto-fill,minmax(100px,1fr)); gap:8px; margin-top:12px; }
    .photo-item{
      aspect-ratio:1;
      border:2px dashed #ddd; border-radius:8px;
      display:flex; align-items:center; justify-content:center;
      cursor:pointer; position:relative; overflow:hidden; background:#f5f5f5;
    }
    .photo-item img{ width:100%; height:100%; object-fit:cover; }
    .photo-item .add-icon{ font-size:32px; color:#999; }
    .photo-item .delete-btn{
      position:absolute; top:4px; right:4px;
      background:rgba(239,83,80,.9); color:#fff;
      border:none; border-radius:50%;
      width:24px; height:24px; font-size:16px; cursor:pointer; display:none;
    }
    .photo-item:hover .delete-btn{ display:block; }

    .signature-container{ margin:20px 0; }
    .signature-label{ background:rgba(0,0,0,.05); padding:12px; border-radius:8px; margin-bottom:12px; }
    .signature-label p{ color:var(--bg); font-size:clamp(14px,3.5vw,16px); font-weight:700; margin:0; }
    .signature-pad{
      width:100%; height:200px; border:2px solid #333; background:#fff;
      border-radius:8px; cursor:crosshair; touch-action:none;
    }
    .signature-controls{ margin-top:10px; }

    .btn{
      width:100%; padding:16px; border:none; border-radius:8px;
      font-size:16px; font-weight:700; cursor:pointer; min-height:52px; transition:all .2s;
    }
    .btn-primary{ background:var(--primary); color:#fff; }
    .btn-primary:active{ background:var(--primary-dark); }
    .btn-secondary{ background:#e0e0e0; color:var(--bg); }
    .btn[disabled]{ opacity:.6; cursor:not-allowed; }

    .toast{
      position:fixed; bottom:100px; left:50%;
      transform:translateX(-50%);
      background:rgba(0,0,0,.85); color:#fff;
      padding:12px 18px; border-radius:10px; font-size:14px;
      z-index:1000; opacity:0; transition:opacity .25s;
      pointer-events:none; max-width:90vw; text-align:center;
    }
    .toast.show{ opacity:1; }

    .hidden{ display:none !important; }
  </style>
</head>

<body>
  <div id="toast" class="toast"></div>

  <div id="home-screen" class="home-screen">
    <div>
      <div class="logo-text">í´ë¦°í•œ ì‚¬ëŒë“¤</div>
      <div class="logo-subtitle">ì…ì£¼ì²­ì†Œ & interior</div>
    </div>
    <div class="menu-grid">
      <div class="menu-item" onclick="showChecklistSelector()">
        <div class="menu-icon">ğŸ“‹</div>
        <div class="menu-title">ì²´í¬ë¦¬ìŠ¤íŠ¸</div>
      </div>
      <div class="menu-item" onclick="showApp('manual')">
        <div class="menu-icon">ğŸ“–</div>
        <div class="menu-title">ë§¤ë‰´ì–¼</div>
      </div>
    </div>
  </div>

  <div id="type-selector-screen" class="app-container">
    <div class="header">
      <button class="back-btn" onclick="goHome()">â†</button>
      <h1>ì²´í¬ë¦¬ìŠ¤íŠ¸ ì„ íƒ</h1>
    </div>
    <div class="container">
      <div class="section">
        <div class="type-selector">
          <button class="type-btn" onclick="selectType('move_in')">
            <div class="icon">ğŸ </div>
            <div class="content">
              <div class="title">ì…ì£¼ì²­ì†Œ</div>
              <div class="desc">í™”ì¥ì‹¤, ê±°ì‹¤, ì£¼ë°© ë“± 7ê°œ êµ¬ì—­</div>
            </div>
            <div class="arrow">â€º</div>
          </button>

          <button class="type-btn" onclick="selectType('shabu')">
            <div class="icon">ğŸ²</div>
            <div class="content">
              <div class="title">ìƒ¤ë¸Œì˜¬ë°ì´ ì˜í†µì </div>
              <div class="desc">Aêµ¬ì—­, Bêµ¬ì—­, í™”ì¥ì‹¤</div>
            </div>
            <div class="arrow">â€º</div>
          </button>

          <button class="type-btn" onclick="selectType('jinsa')">
            <div class="icon">ğŸ¥©</div>
            <div class="content">
              <div class="title">ëª…ë¥œì§„ì‚¬ê°ˆë¹„ ì˜í†µì </div>
              <div class="desc">ë°”ë‹¥ ì²­ì†Œ</div>
            </div>
            <div class="arrow">â€º</div>
          </button>
        </div>
      </div>
    </div>
  </div>

  <div id="checklist-app" class="app-container">
    <div class="header">
      <button class="back-btn" onclick="goHome()">â†</button>
      <div><h1 id="checklist-title">ì²´í¬ë¦¬ìŠ¤íŠ¸</h1></div>
    </div>

    <div class="container">
      <div class="section">
        <div class="form-group">
          <label class="form-label">ê³ ê°ëª… / ë§¤ì¥ëª…</label>
          <input type="text" class="form-input" id="customerName" placeholder="ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”">
        </div>
        <div class="form-group">
          <label class="form-label">ì‘ì—… ìœ„ì¹˜</label>
          <input type="text" class="form-input" id="location" placeholder="ì£¼ì†Œë¥¼ ì…ë ¥í•˜ì„¸ìš”">
        </div>
        <div class="form-group">
          <label class="form-label">ë‹´ë‹¹ì</label>
          <input type="text" class="form-input" id="worker" placeholder="ë‹´ë‹¹ìëª…ì„ ì…ë ¥í•˜ì„¸ìš”">
        </div>
      </div>

      <div id="checklist-sections"></div>

      <div class="section">
        <div class="section-title">íŠ¹ì´ì‚¬í•­</div>
        <textarea class="form-input" id="notes" placeholder="íŠ¹ì´ì‚¬í•­ì„ ì…ë ¥í•˜ì„¸ìš”"></textarea>
      </div>

      <div class="section">
        <div class="section-title">ì„œëª…</div>

        <div class="signature-container">
          <div class="signature-label"><p>ì‘ì—…ì„ ì™„ë£Œí•œ íŒ€ì¥ë‹˜ê»˜ì„œ ì„œëª…í•´ì£¼ì„¸ìš”</p></div>
          <canvas id="signature-pad-team" class="signature-pad"></canvas>
          <div class="signature-controls">
            <button class="btn btn-secondary" onclick="clearSignature('team')">ì„œëª… ì§€ìš°ê¸°</button>
          </div>
        </div>

        <div class="signature-container">
          <div class="signature-label"><p>ì‘ì—…ì„ í™•ì¸í•œ ê³ ê°ë‹˜ê»˜ì„œ ì„œëª…í•´ì£¼ì„¸ìš”</p></div>
          <canvas id="signature-pad-customer" class="signature-pad"></canvas>
          <div class="signature-controls">
            <button class="btn btn-secondary" onclick="clearSignature('customer')">ì„œëª… ì§€ìš°ê¸°</button>
          </div>
        </div>
      </div>

      <button id="submitBtn" class="btn btn-primary" onclick="generateReport()" style="margin-top:20px;">
        ì™„ë£Œ ë° ì „ì†¡
      </button>
    </div>
  </div>

  <div id="manual-app" class="app-container">
    <div class="header">
      <button class="back-btn" onclick="goHome()">â†</button>
      <h1>ì—…ë¬´ ë§¤ë‰´ì–¼</h1>
    </div>
    <div class="container">
      <div class="section">
        <div class="section-title">ì‚¬ìš© ë°©ë²•</div>
        <ul style="padding-left:20px;color:var(--bg);line-height:1.8;">
          <li>ì²´í¬ë¦¬ìŠ¤íŠ¸ ì¢…ë¥˜ë¥¼ ì„ íƒí•©ë‹ˆë‹¤</li>
          <li>ê° ì„¹ì…˜ë³„ë¡œ ìµœëŒ€ 10ì¥ê¹Œì§€ ì‚¬ì§„ì„ ì—…ë¡œë“œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤</li>
          <li>íŠ¹ì´ì‚¬í•­ì„ ê¸°ë¡í•©ë‹ˆë‹¤</li>
          <li>íŒ€ì¥ê³¼ ê³ ê°ì˜ ì„œëª…ì„ ë°›ìŠµë‹ˆë‹¤</li>
          <li>ì™„ë£Œ ë²„íŠ¼ì„ ëˆ„ë¥´ë©´ <b>PDFì™€ ì‚¬ì§„ ZIP</b>ì´ ìë™ìœ¼ë¡œ ì´ë©”ì¼ ì „ì†¡ë©ë‹ˆë‹¤</li>
        </ul>
      </div>
    </div>
  </div>

  <script>
    // ===============================
    // ì„¤ì •
    // ===============================
    const GOOGLE_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbwk2HsvXu7lfLEa6Npu9B4EkcVkQW-anpMoRypV3WoJWDHsvHhOd4xdIxXwgGnu76mi/exec';
    const FIXED_EMAIL = 'kjg2000914@naver.com';

    let currentType = null;
    let photos = {};

    const checklistTypes = {
      move_in: {
        name: 'ì…ì£¼ì²­ì†Œ',
        sections: {
          bathroom: 'í™”ì¥ì‹¤',
          living: 'ê±°ì‹¤',
          kitchen: 'ì£¼ë°©',
          bedroom: 'ë°©',
          laundry: 'ì„¸íƒì‹¤',
          veranda: 'ë² ë€ë‹¤',
          entrance: 'í˜„ê´€'
        }
      },
      shabu: {
        name: 'ìƒ¤ë¸Œì˜¬ë°ì´ ì˜í†µì ',
        sections: {
          area_a: 'Aêµ¬ì—­ ë°”ë‹¥',
          area_b: 'Bêµ¬ì—­ ë°”ë‹¥',
          bathroom: 'í™”ì¥ì‹¤'
        }
      },
      jinsa: {
        name: 'ëª…ë¥œì§„ì‚¬ê°ˆë¹„ ì˜í†µì ',
        sections: { floor: 'ë°”ë‹¥' }
      }
    };

    // ===============================
    // í™”ë©´ ì „í™˜
    // ===============================
    function showApp(appName) {
      document.getElementById('home-screen').style.display = 'none';
      document.querySelectorAll('.app-container').forEach(el => el.classList.remove('active'));
      const app = document.getElementById(appName + '-app');
      if (app) app.classList.add('active');
    }

    function goHome() {
      document.querySelectorAll('.app-container').forEach(el => el.classList.remove('active'));
      document.getElementById('home-screen').style.display = 'flex';
    }

    function showChecklistSelector() {
      document.getElementById('home-screen').style.display = 'none';
      document.querySelectorAll('.app-container').forEach(el => el.classList.remove('active'));
      document.getElementById('type-selector-screen').classList.add('active');
    }

    function selectType(type) {
      currentType = type;
      const typeData = checklistTypes[type];
      document.getElementById('checklist-title').textContent = typeData.name;
      renderChecklist(typeData);
      showApp('checklist');
      setTimeout(() => initSignaturePads(), 250);
    }

    // ===============================
    // ì²´í¬ë¦¬ìŠ¤íŠ¸ ë Œë”
    // ===============================
    function renderChecklist(typeData) {
      const container = document.getElementById('checklist-sections');
      container.innerHTML = '';
      photos = {};

      Object.entries(typeData.sections).forEach(([key, name]) => {
        photos[key] = [];
        const section = document.createElement('div');
        section.className = 'section';
        section.innerHTML = `
          <div class="section-title">${name}</div>
          <div id="photos-${key}" class="photo-grid"></div>
        `;
        container.appendChild(section);
        renderPhotoGrid(key);
      });
    }

    function renderPhotoGrid(sectionId) {
      const grid = document.getElementById(`photos-${sectionId}`);
      grid.innerHTML = '';

      const sectionPhotos = photos[sectionId] || [];

      sectionPhotos.forEach((item, index) => {
        const div = document.createElement('div');
        div.className = 'photo-item';
        div.innerHTML = `
          <img src="${item.preview}" alt="ì‚¬ì§„ ${index + 1}">
          <button class="delete-btn" onclick="deletePhoto('${sectionId}', ${index})">Ã—</button>
        `;
        grid.appendChild(div);
      });

      if (sectionPhotos.length < 10) {
        const addItem = document.createElement('div');
        addItem.className = 'photo-item';
        addItem.innerHTML = `
          <div class="add-icon">+</div>
          <input type="file" accept="image/*" style="display:none" onchange="addPhoto('${sectionId}', this)" id="file-${sectionId}">
        `;
        addItem.onclick = () => document.getElementById(`file-${sectionId}`).click();
        grid.appendChild(addItem);
      }
    }

    async function addPhoto(sectionId, input) {
      try {
        if (!input.files || !input.files[0]) return;

        const file = input.files[0];

        if (!file.type.startsWith('image/')) {
          showToast('ì´ë¯¸ì§€ íŒŒì¼ë§Œ ì—…ë¡œë“œ ê°€ëŠ¥í•©ë‹ˆë‹¤');
          input.value = '';
          return;
        }

        if (file.size > 10 * 1024 * 1024) {
          showToast('íŒŒì¼ í¬ê¸°ëŠ” 10MB ì´í•˜ì—¬ì•¼ í•©ë‹ˆë‹¤');
          input.value = '';
          return;
        }

        const previewDataUrl = await new Promise((resolve, reject) => {
          const reader = new FileReader();
          reader.onload = (e) => resolve(e.target.result);
          reader.onerror = reject;
          reader.readAsDataURL(file);
        });

        photos[sectionId].push({ preview: previewDataUrl, file });
        renderPhotoGrid(sectionId);
        showToast('ì‚¬ì§„ì´ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤');

      } catch (e) {
        console.error('ì‚¬ì§„ ì¶”ê°€ ì˜¤ë¥˜:', e);
        showToast('ì‚¬ì§„ ì¶”ê°€ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤');
      } finally {
        input.value = '';
      }
    }

    function deletePhoto(sectionId, index) {
      photos[sectionId].splice(index, 1);
      renderPhotoGrid(sectionId);
      showToast('ì‚¬ì§„ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤');
    }

    // ===============================
    // ì„œëª…
    // ===============================
    function initSignaturePads() {
      initSignaturePad('signature-pad-team');
      initSignaturePad('signature-pad-customer');
    }

    function initSignaturePad(canvasId) {
      const canvas = document.getElementById(canvasId);
      if (!canvas) return;

      const rect = canvas.getBoundingClientRect();
      canvas.width = rect.width;
      canvas.height = 200;

      const ctx = canvas.getContext('2d');
      ctx.fillStyle = '#ffffff';
      ctx.fillRect(0, 0, canvas.width, canvas.height);
      ctx.strokeStyle = '#000000';
      ctx.lineWidth = 2;
      ctx.lineCap = 'round';

      let isDrawing = false;
      let lastX = 0, lastY = 0;

      function startDrawing(e) {
        isDrawing = true;
        const r = canvas.getBoundingClientRect();
        const clientX = e.touches ? e.touches[0].clientX : e.clientX;
        const clientY = e.touches ? e.touches[0].clientY : e.clientY;
        lastX = clientX - r.left;
        lastY = clientY - r.top;
      }

      function draw(e) {
        if (!isDrawing) return;
        e.preventDefault();

        const r = canvas.getBoundingClientRect();
        const clientX = e.touches ? e.touches[0].clientX : e.clientX;
        const clientY = e.touches ? e.touches[0].clientY : e.clientY;
        const x = clientX - r.left;
        const y = clientY - r.top;

        ctx.beginPath();
        ctx.moveTo(lastX, lastY);
        ctx.lineTo(x, y);
        ctx.stroke();

        lastX = x;
        lastY = y;
      }

      function stopDrawing() { isDrawing = false; }

      canvas.onmousedown = startDrawing;
      canvas.onmousemove = draw;
      canvas.onmouseup = stopDrawing;
      canvas.onmouseleave = stopDrawing;

      canvas.addEventListener('touchstart', startDrawing, { passive: false });
      canvas.addEventListener('touchmove', draw, { passive: false });
      canvas.addEventListener('touchend', stopDrawing);
    }

    function clearSignature(type) {
      const canvas = document.getElementById(`signature-pad-${type}`);
      if (!canvas) return;
      const ctx = canvas.getContext('2d');
      ctx.fillStyle = '#ffffff';
      ctx.fillRect(0, 0, canvas.width, canvas.height);
      showToast('ì„œëª…ì´ ì§€ì›Œì¡ŒìŠµë‹ˆë‹¤');
    }

    function hasSignature(canvas) {
      const ctx = canvas.getContext('2d');
      const { data } = ctx.getImageData(0, 0, canvas.width, canvas.height);
      let darkCount = 0;
      for (let i = 0; i < data.length; i += 4) {
        const r = data[i], g = data[i+1], b = data[i+2];
        if (r < 240 || g < 240 || b < 240) darkCount++;
        if (darkCount > 200) return true;
      }
      return false;
    }

    // ===============================
    // âœ… ì´ë¯¸ì§€ ë¦¬ì‚¬ì´ì¦ˆ í•¨ìˆ˜(ëˆ„ë½ë˜ì–´ ìˆì–´ì„œ ì¶”ê°€)
    // - maxSize: ìµœëŒ€ ë³€ ê¸¸ì´(px)
    // - quality: jpeg í’ˆì§ˆ(0~1)
    // ===============================
    async function resizeImage(file, maxSize = 1200, quality = 0.7) {
      const dataUrl = await new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = () => resolve(reader.result);
        reader.onerror = reject;
        reader.readAsDataURL(file);
      });

      const img = await new Promise((resolve, reject) => {
        const i = new Image();
        i.onload = () => resolve(i);
        i.onerror = reject;
        i.src = dataUrl;
      });

      let { width, height } = img;
      const maxDim = Math.max(width, height);
      if (maxDim > maxSize) {
        const scale = maxSize / maxDim;
        width = Math.round(width * scale);
        height = Math.round(height * scale);
      }

      const canvas = document.createElement('canvas');
      canvas.width = width;
      canvas.height = height;
      const ctx = canvas.getContext('2d');
      ctx.fillStyle = '#ffffff';
      ctx.fillRect(0, 0, width, height);
      ctx.drawImage(img, 0, 0, width, height);

      const blob = await new Promise((resolve) => {
        canvas.toBlob((b) => resolve(b), 'image/jpeg', quality);
      });

      return blob;
    }

    // ===============================
    // âœ… ì „ì†¡ í•µì‹¬(ë°©ì‹ ìœ ì§€)
    // - ê°€ì¥ ì•ˆì •: sendBeacon (POST + text/plain)
    // - ì‹¤íŒ¨ ì‹œ: fetch(no-cors) fallback
    // ===============================
    async function postJsonNoCors(jsonString) {
      // 1) sendBeacon (ê°€ì¥ ì•ˆì •: ëª¨ë°”ì¼/ë°±ê·¸ë¼ìš´ë“œ ì „í™˜ì—ë„ ì˜ ë³´ëƒ„)
      try {
        if (navigator.sendBeacon) {
          const ok = navigator.sendBeacon(
            GOOGLE_SCRIPT_URL,
            new Blob([jsonString], { type: 'text/plain;charset=UTF-8' })
          );
          if (ok) return { sent: true, method: 'beacon' };
        }
      } catch (e) {
        console.log('sendBeacon ì‹¤íŒ¨:', e);
      }

      // 2) fetch no-cors fallback
      try {
        await fetch(GOOGLE_SCRIPT_URL, {
          method: 'POST',
          mode: 'no-cors',
          headers: { 'Content-Type': 'text/plain;charset=UTF-8' },
          body: jsonString
        });
        return { sent: true, method: 'fetch-no-cors' };
      } catch (e) {
        throw new Error('ì „ì†¡ ì‹¤íŒ¨: ' + (e?.message || e));
      }
    }

    // ===============================
    // ì „ì†¡
    // ===============================
    async function generateReport() {
      const btn = document.getElementById('submitBtn');
      if (btn.disabled) return;

      const customerName = document.getElementById('customerName').value.trim();
      const location = document.getElementById('location').value.trim();
      const worker = document.getElementById('worker').value.trim();
      const notes = document.getElementById('notes').value.trim();

      if (!customerName || !location || !worker) {
        showToast('ê¸°ë³¸ ì •ë³´ë¥¼ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”');
        return;
      }

      const canvasTeam = document.getElementById('signature-pad-team');
      const canvasCustomer = document.getElementById('signature-pad-customer');

      if (!hasSignature(canvasTeam)) {
        showToast('íŒ€ì¥ ì„œëª…ì„ í•´ì£¼ì„¸ìš”');
        return;
      }
      if (!hasSignature(canvasCustomer)) {
        showToast('ê³ ê° ì„œëª…ì„ í•´ì£¼ì„¸ìš”');
        return;
      }

      const typeData = checklistTypes[currentType];
      const today = new Date();
      const isoDate = today.toISOString().split('T')[0];
      const fileNameBase = `${typeData.name}_${customerName}_${isoDate}`.replace(/[\\/:*?"<>|]/g, '_');

      btn.disabled = true;
      btn.textContent = 'ì „ì†¡ ì¤‘...';
      showToast('íŒŒì¼ ìƒì„± ì¤‘...');

      try {
        console.log('=== 1ë‹¨ê³„: ZIP ìƒì„± ì‹œì‘ ===');
        const zip = new JSZip();
        let photoCount = 0;

        for (const [sectionId, arr] of Object.entries(photos)) {
          if (!arr || arr.length === 0) continue;

          const sectionName = typeData.sections[sectionId] || sectionId;
          const folder = zip.folder(sectionName);

          for (let idx = 0; idx < arr.length; idx++) {
            try {
              const item = arr[idx];
              const file = item.file;

              const resizedBlob = await resizeImage(file, 1200, 0.7);

              const safeSection = sectionName.replace(/[\\/:*?"<>|]/g, '_');
              const num = String(idx + 1).padStart(2, '0');
              const outName = `${safeSection}_${num}.jpg`; // âœ… ë¦¬ì‚¬ì´ì¦ˆ ê²°ê³¼ëŠ” jpgë¡œ ê³ ì •

              folder.file(outName, resizedBlob);
              photoCount++;
            } catch (photoErr) {
              console.error(`ì‚¬ì§„ ${idx} ì¶”ê°€ ì‹¤íŒ¨:`, photoErr);
            }
          }
        }

        console.log(`ì´ ${photoCount}ì¥ì˜ ì‚¬ì§„ ì¶”ê°€ë¨`);

        showToast('ì‚¬ì§„ ì••ì¶• ì¤‘...');
        const zipBase64 = await zip.generateAsync({
          type: 'base64',
          compression: 'DEFLATE',
          compressionOptions: { level: 9 }
        });
        const zipSizeKB = Math.round(zipBase64.length / 1024);
        console.log('ZIP ìƒì„± ì™„ë£Œ, í¬ê¸°:', zipSizeKB, 'KB');

        if (zipSizeKB > 20000) {
          throw new Error('ZIP íŒŒì¼ì´ ë„ˆë¬´ í½ë‹ˆë‹¤ (20MB ì´ˆê³¼). ì‚¬ì§„ ê°œìˆ˜ë¥¼ ì¤„ì—¬ì£¼ì„¸ìš”.');
        }

        console.log('=== 2ë‹¨ê³„: PDF ìƒì„± ì‹œì‘ ===');
        showToast('ë³´ê³ ì„œ(PDF) ìƒì„± ì¤‘...');

        btn.classList.add('hidden');

        const element = document.getElementById('checklist-app');

        const canvas = await html2canvas(element, {
          scale: 1.5,
          backgroundColor: '#0a0a0a',
          useCORS: true,
          logging: false
        });

        btn.classList.remove('hidden');
        btn.textContent = 'ì „ì†¡ ì¤‘...';
        btn.disabled = true;

        const imgData = canvas.toDataURL('image/jpeg', 0.85);

        const { jsPDF } = window.jspdf;
        const pdf = new jsPDF('p', 'mm', 'a4');

        const pageWidth = 210;
        const pageHeight = 297;
        const imgWidth = pageWidth;
        const imgHeight = (canvas.height * imgWidth) / canvas.width;

        let heightLeft = imgHeight;
        let position = 0;

        pdf.addImage(imgData, 'JPEG', 0, position, imgWidth, imgHeight);
        heightLeft -= pageHeight;

        while (heightLeft > 0) {
          position -= pageHeight;
          pdf.addPage();
          pdf.addImage(imgData, 'JPEG', 0, position, imgWidth, imgHeight);
          heightLeft -= pageHeight;
        }

        const pdfBase64 = pdf.output('dataurlstring').split(',')[1];
        console.log('PDF Base64 í¬ê¸°:', Math.round(pdfBase64.length / 1024), 'KB');

        console.log('=== 3ë‹¨ê³„: ì´ë©”ì¼ ì „ì†¡ ì‹œì‘ ===');
        showToast('ì´ë©”ì¼ ì „ì†¡ ì¤‘...');

        const emailData = {
          to_email: FIXED_EMAIL,
          customer_name: customerName,
          location,
          worker,
          notes,
          checklist_type: typeData.name,
          date: today.toLocaleDateString('ko-KR'),
          pdf_base64: pdfBase64,
          pdf_filename: `${fileNameBase}.pdf`,
          zip_base64: zipBase64,
          zip_filename: `${fileNameBase}_ì‚¬ì§„.zip`
        };

        const payload = JSON.stringify(emailData);
        console.log('ì „ì†¡ ë°ì´í„° í¬ê¸°:', Math.round(payload.length / 1024), 'KB');

        // âœ… í•µì‹¬: ì•ˆì • ì „ì†¡ (beacon â†’ fetch no-cors)
        const sentInfo = await postJsonNoCors(payload);
        console.log('ì „ì†¡ ìš”ì²­ ë³´ëƒ„:', sentInfo);

        // no-cors / beaconì€ ì‘ë‹µ í™•ì¸ì´ ë¶ˆê°€ëŠ¥í•˜ë‹ˆ, ì¼ë‹¨ ì „ì†¡ ì•ˆë‚´
        showToast(`ì „ì†¡ ìš”ì²­ ì™„ë£Œ! (${FIXED_EMAIL})`);

        setTimeout(() => {
          resetChecklistForm();
        }, 2000);

      } catch (error) {
        console.error('=== ì˜¤ë¥˜ ë°œìƒ ===');
        console.error('ì˜¤ë¥˜:', error);
        showToast('ì˜¤ë¥˜: ' + (error.message || error));
      } finally {
        btn.disabled = false;
        btn.textContent = 'ì™„ë£Œ ë° ì „ì†¡';
      }
    }

    function resetChecklistForm() {
      document.getElementById('customerName').value = '';
      document.getElementById('location').value = '';
      document.getElementById('worker').value = '';
      document.getElementById('notes').value = '';

      const typeData = checklistTypes[currentType];
      if (typeData) renderChecklist(typeData);

      clearSignature('team');
      clearSignature('customer');

      goHome();
    }

    // ===============================
    // Toast
    // ===============================
    function showToast(message) {
      const toast = document.getElementById('toast');
      toast.textContent = message;
      toast.classList.add('show');
      setTimeout(() => toast.classList.remove('show'), 2500);
    }
  </script>
</body>
</html>
