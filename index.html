<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <title>í´ë¦°í•œ ì‚¬ëŒë“¤</title>

  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;600;700;800;900&display=swap" rel="stylesheet" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>

  <style>
    *{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent}
    :root{
      --bg:#0b0b0c;
      --card:#ffffff;
      --text:#111;
      --muted:#6b6f76;
      --line:#eceef2;
      --soft:#f6f7f9;
      --primary:#1f2937;
      --primary2:#0b5ed7;
      --danger:#d32f2f;
      --success:#2e7d32;
      --shadow:0 6px 20px rgba(0,0,0,.08);
      --radius:16px;
    }

    body{
      font-family:'Noto Sans KR',system-ui,-apple-system,sans-serif;
      background:var(--bg);
      color:#fff;
      font-size:14px;
      line-height:1.4;
    }

    /* ===== í™ˆ ===== */
    .home{
      min-height:100vh;
      display:flex;
      align-items:center;
      justify-content:center;
      padding:18px;
      position:relative;
      overflow:hidden;
      background:linear-gradient(135deg,#101015 0%, #222433 100%);
    }
    .home::before{
      content:'';
      position:absolute;
      inset:-60%;
      background:radial-gradient(circle, rgba(0,102,255,.14) 0%, transparent 70%);
      animation:spin 18s linear infinite;
    }
    @keyframes spin{from{transform:rotate(0)}to{transform:rotate(360deg)}}

    .home-inner{position:relative;z-index:1;width:100%;max-width:420px}
    .brand{text-align:center;margin-bottom:18px}
    .brand h1{font-size:28px;font-weight:900;letter-spacing:-1px;margin-bottom:6px}
    .brand p{font-size:11px;opacity:.75;letter-spacing:1px}

    .home-grid{
      display:grid;
      grid-template-columns:1fr 1fr;
      gap:10px;
    }

    /* âœ… í™ˆ íƒ€ì¼: ì•„ì´ì½˜+ê¸€ì ì „ì²´ ì¤‘ì•™ì •ë ¬ */
    .tile{
      background:rgba(255,255,255,.10);
      border:1px solid rgba(255,255,255,.14);
      border-radius:18px;
      padding:16px 12px;
      cursor:pointer;
      backdrop-filter:blur(10px);
      transition:transform .12s ease;
      user-select:none;

      display:flex;
      flex-direction:column;
      align-items:center;
      justify-content:center;
      text-align:center;
      min-height:120px;
    }
    .tile:active{transform:scale(.98)}
    .tile .icon{font-size:28px;margin-bottom:8px;line-height:1}
    .tile .title{font-size:13px;font-weight:900;margin-bottom:4px}
    .tile .desc{font-size:11px;opacity:.75}

    /* ===== ì•± ===== */
    .app{display:none}
    .app.active{display:block}

    .topbar{
      position:sticky; top:0; z-index:50;
      background:linear-gradient(135deg,var(--primary) 0%, var(--primary2) 100%);
      padding:10px 12px;
      display:flex;
      align-items:center;
      gap:10px;
      box-shadow:0 8px 18px rgba(0,0,0,.18);
    }
    .back{
      width:38px;height:38px;
      border-radius:14px;
      border:none;
      background:rgba(255,255,255,.12);
      color:#fff;
      font-size:18px;
      font-weight:900;
      cursor:pointer;
    }
    .topbar h2{font-size:14px;font-weight:900;line-height:1.1}
    .topbar p{font-size:11px;opacity:.85;margin-top:3px}

    .wrap{
      width:100%;
      max-width:520px;
      margin:0 auto;
      padding:10px 12px 92px;
    }

    .card{
      background:var(--card);
      color:var(--text);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      padding:12px;
      margin-bottom:10px;
    }
    .card-title{
      font-size:13px;
      font-weight:900;
      margin-bottom:10px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
    }
    .small{font-size:11px;color:var(--muted);font-weight:700}

    .field{margin-bottom:10px}
    .label{font-size:12px;font-weight:900;margin-bottom:6px;color:#111}
    .input, .textarea{
      width:100%;
      border:1px solid var(--line);
      border-radius:14px;
      padding:10px 12px;
      font-size:14px;
      outline:none;
      background:#fff;
    }
    .textarea{min-height:84px;resize:vertical}

    /* ===== ì•„ì½”ë””ì–¸ ===== */
    .acc{
      border:1px solid var(--line);
      border-radius:18px;
      overflow:hidden;
      margin-bottom:10px;
      background:#fff;
    }
    .acc-btn{
      width:100%;
      border:none;
      background:#fff;
      color:#111;
      padding:12px 12px;
      cursor:pointer;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      font-weight:900;
      font-size:13px;
    }
    .acc-btn:active{background:#fafafa}
    .acc-btn .right{
      display:flex; align-items:center; gap:8px; color:var(--muted); font-size:11px; font-weight:800;
    }
    .acc-body{display:none;padding:0 12px 12px;background:#fff}
    .acc.open .acc-body{display:block}
    .chip{
      font-size:10px;
      font-weight:900;
      padding:5px 8px;
      border-radius:999px;
      background:var(--soft);
      color:#333;
      border:1px solid #eee;
    }

    /* ì‚¬ì§„ */
    .item{
      background:var(--soft);
      border:1px solid #eee;
      border-radius:16px;
      padding:10px;
      margin-top:10px;
    }
    .item-name{font-weight:900;font-size:13px;color:#111;margin-bottom:8px}
    .photos{display:grid;grid-template-columns:1fr 1fr;gap:8px}
    .ph{
      position:relative;
      border:2px dashed #bdbdbd;
      border-radius:16px;
      overflow:hidden;
      aspect-ratio:4/3;
      background:#fff;
      cursor:pointer;
    }
    .ph.has{border-style:solid;border-color:var(--success)}
    .ph img{
      position:absolute; inset:0;
      width:100%; height:100%;
      object-fit:cover;
      display:none;
      pointer-events:none;
    }
    .ph.has img{display:block}

    /* âœ… ì‚¬ì§„ ì—…ë¡œë“œ í›„ "ì‘ì—… ì „/í›„" ì˜¤ë²„ë ˆì´ ìˆ¨ê¹€ */
    .ph.has .overlay{display:none;}

    .ph .overlay{
      position:absolute; inset:0;
      display:flex; flex-direction:column;
      align-items:center; justify-content:center;
      gap:5px;
      color:#111;
      text-align:center;
      padding:10px;
    }
    .ph .overlay .ico{font-size:26px}
    .ph .overlay .t{font-size:12px;font-weight:900}
    .ph .overlay .s{font-size:10px;color:var(--muted);font-weight:800}

    /* ì„œëª… */
    .sig-wrap{margin-top:10px}
    .sig-title{font-size:12px;font-weight:900;color:#111;margin-bottom:8px}
    .canvas{
      width:100%;
      height:190px;
      border:2px solid #333;
      border-radius:16px;
      background:#fff;
      touch-action:none;
    }

    .grid2{display:grid;grid-template-columns:1fr 1fr;gap:8px}
    .btn{
      border:none;
      border-radius:16px;
      padding:12px 10px;
      font-size:13px;
      font-weight:900;
      cursor:pointer;
    }
    .btn.primary{background:var(--primary);color:#fff}
    .btn.primary:active{opacity:.9}
    .btn.blue{background:var(--primary2);color:#fff}
    .btn.gray{background:#e9eaee;color:#111}
    .btn.red{background:#ffe8ea;color:#b71c1c}
    .btn.full{width:100%}

    .toast{
      position:fixed;
      left:50%;
      transform:translateX(-50%);
      bottom:16px;
      z-index:999;
      background:rgba(0,0,0,.85);
      color:#fff;
      padding:10px 14px;
      border-radius:999px;
      font-size:12px;
      opacity:0;
      transition:opacity .2s ease;
      max-width:calc(100% - 24px);
      text-align:center;
    }
    .toast.show{opacity:1}

    @media (max-width:360px){
      .wrap{padding:10px 10px 92px}
      .brand h1{font-size:26px}
      .tile{padding:14px 10px; min-height:112px}
      .btn{padding:11px 10px}
      .canvas{height:170px}
      .acc-btn{padding:11px 11px}
    }
  </style>
</head>

<body>
  <!-- HOME -->
  <div id="home" class="home">
    <div class="home-inner">
      <div class="brand">
        <h1>í´ë¦°í•œ ì‚¬ëŒë“¤</h1>
        <p>ì…ì£¼ì²­ì†Œ & interior</p>
      </div>

      <div class="home-grid">
        <div class="tile" onclick="showApp('checklist')">
          <div class="icon">ğŸ“‹</div>
          <div class="title">ì²´í¬ë¦¬ìŠ¤íŠ¸</div>
          <div class="desc">ì‚¬ì§„ Â· ì„œëª… Â· ì œì¶œ</div>
        </div>
        <div class="tile" onclick="showApp('manual')">
          <div class="icon">ğŸ“–</div>
          <div class="title">ë§¤ë‰´ì–¼</div>
          <div class="desc">ì—…ë¬´ ê°€ì´ë“œ</div>
        </div>
      </div>
    </div>
  </div>

  <!-- CHECKLIST APP -->
  <div id="checklist-app" class="app">
    <div class="topbar">
      <button class="back" onclick="goHome()">â†</button>
      <div>
        <h2>ì‘ì—… ì²´í¬ë¦¬ìŠ¤íŠ¸</h2>
        <p>êµ¬ì—­ ì—´ê³  ì‚¬ì§„ ì²¨ë¶€ â†’ ì„œëª… â†’ ì œì¶œ</p>
      </div>
    </div>

    <div class="wrap">
      <div class="card">
        <div class="card-title">
          <span>ê¸°ë³¸ ì •ë³´</span>
          <span class="small">í•„ìˆ˜ ì…ë ¥</span>
        </div>

        <div class="field">
          <div class="label">ê³ ê°ëª…</div>
          <input id="customerName" class="input" type="text" placeholder="ê³ ê°ëª…" />
        </div>
        <div class="field">
          <div class="label">ì‘ì—… ìœ„ì¹˜</div>
          <input id="location" class="input" type="text" placeholder="ì‘ì—… ìœ„ì¹˜" />
        </div>
        <div class="field" style="margin-bottom:0">
          <div class="label">ë‹´ë‹¹ì</div>
          <input id="worker" class="input" type="text" placeholder="ë‹´ë‹¹ì" />
        </div>
      </div>

      <div id="sections"></div>

      <div class="card">
        <div class="card-title"><span>íŠ¹ì´ì‚¬í•­</span><span class="small">ì„ íƒ</span></div>
        <textarea id="notes" class="textarea" placeholder="íŠ¹ì´ì‚¬í•­ì„ ì…ë ¥í•˜ì„¸ìš”"></textarea>
      </div>

      <div class="card">
        <div class="card-title"><span>í™˜ë¶ˆ ê·œì •</span></div>
        <div style="background:var(--soft); border:1px solid #eee; padding:10px; border-radius:16px; color:#222; font-size:12px; line-height:1.55;">
          <p style="margin-bottom:8px;">â€» ì‘ì—… ì™„ë£Œ í›„ í™˜ë¶ˆì€ ë¶ˆê°€í•©ë‹ˆë‹¤.</p>
          <p style="margin-bottom:8px;">â€» ê³ ê°ë‹˜ ë¶€ì¬ ì‹œ ëŒ€ë¦¬ì¸ ì„œëª…ìœ¼ë¡œ ì‘ì—… í™•ì¸ì´ ê°€ëŠ¥í•©ë‹ˆë‹¤.</p>
          <p style="margin:0;">â€» ëŒ€ë¦¬ ì„œëª…ì˜ ê²½ìš°ì—ë„ ë³¸ í™˜ë¶ˆ ê·œì •ì´ ë™ì¼í•˜ê²Œ ì ìš©ë©ë‹ˆë‹¤.</p>
        </div>
      </div>

      <div class="card">
        <div class="card-title"><span>ì„œëª…</span></div>

        <div class="sig-wrap">
          <div class="sig-title">íŒ€ì¥ ì„œëª…</div>
          <canvas id="sigTeam" class="canvas"></canvas>
          <button class="btn gray full" style="margin-top:8px" onclick="clearSig('team')">ì„œëª… ì§€ìš°ê¸°</button>
        </div>

        <div class="sig-wrap" style="margin-top:14px">
          <div class="sig-title">ê³ ê°/ëŒ€ë¦¬ì¸ ì„œëª…</div>
          <canvas id="sigCustomer" class="canvas"></canvas>
          <button class="btn gray full" style="margin-top:8px" onclick="clearSig('customer')">ì„œëª… ì§€ìš°ê¸°</button>
        </div>
      </div>

      <div class="card">
        <div class="card-title"><span>ì œì¶œ / PDF</span></div>
        <div class="grid2">
          <button class="btn gray" onclick="downloadPDF()">PDF ë‹¤ìš´ë¡œë“œ</button>
          <button class="btn blue" onclick="submitAll()">ì œì¶œí•˜ê¸°</button>
        </div>
        <button class="btn red full" style="margin-top:8px" onclick="resetAll(true)">ì „ì²´ ì´ˆê¸°í™”</button>
      </div>
    </div>
  </div>

  <!-- MANUAL APP -->
  <div id="manual-app" class="app">
    <div class="topbar">
      <button class="back" onclick="goHome()">â†</button>
      <div>
        <h2>ì—…ë¬´ ë§¤ë‰´ì–¼</h2>
        <p>ì²­ì†Œ ì—…ë¬´ ê°€ì´ë“œ</p>
      </div>
    </div>

    <div class="wrap">
      <div class="card" style="padding:0; overflow:hidden;">
        <div class="acc" style="margin:0;border:none;border-radius:0">
          <button class="acc-btn" onclick="toggleManual('customer')">
            ê³ ê° ëŒ€ì‘ ë§¤ë‰´ì–¼
            <span class="right"><span class="chip">ì—´ê¸°</span> â–¾</span>
          </button>
          <div class="acc-body" id="manual-customer" style="display:none;padding:0 12px 12px">
            <ul style="padding-left:16px;color:#111">
              <li style="margin-bottom:7px">ì¶”ê°€ê¸ˆì•¡ì€ ì‘ì—… ì „ ê³ ì§€</li>
              <li style="margin-bottom:7px">ì „ë‚  18ì‹œ ì´ì „ í•´í”¼ì½œ</li>
              <li style="margin-bottom:7px">ì„œë¹„ìŠ¤ ë²”ìœ„ ì•ˆë‚´</li>
              <li style="margin-bottom:7px">ì²­ì†Œ ë¶ˆê°€ ë²”ìœ„ ì‚¬ì „ ê³ ì§€</li>
              <li style="margin-bottom:7px">í•˜ì ì²´í¬ ì„œë¹„ìŠ¤ ì•ˆë‚´</li>
              <li>í•˜ì ì±…ì„ ì†Œì¬ ì—†ìŒ ì‚¬ì „ ê³ ì§€</li>
            </ul>
          </div>
        </div>
      </div>

      <div class="card" style="padding:0; overflow:hidden;">
        <div class="acc" style="margin:0;border:none;border-radius:0">
          <button class="acc-btn" onclick="toggleManual('checklist')">
            ì²´í¬ë¦¬ìŠ¤íŠ¸ ì‘ì„±ë²•
            <span class="right"><span class="chip">ì—´ê¸°</span> â–¾</span>
          </button>
          <div class="acc-body" id="manual-checklist" style="display:none;padding:0 12px 12px">
            <ul style="padding-left:16px;color:#111">
              <li style="margin-bottom:7px">ê° êµ¬ì—­ ì „/í›„ ì‚¬ì§„ ì´¬ì˜</li>
              <li style="margin-bottom:7px">íŠ¹ì´ì‚¬í•­ì€ êµ¬ì²´ì ìœ¼ë¡œ</li>
              <li style="margin-bottom:7px">ê³ ê°ëª…/ìœ„ì¹˜/ë‹´ë‹¹ì ì •í™•íˆ</li>
              <li>ì„œëª… ì™„ë£Œ í›„ ì œì¶œ</li>
            </ul>
          </div>
        </div>
      </div>

      <div class="card" style="padding:0; overflow:hidden;">
        <div class="acc" style="margin:0;border:none;border-radius:0">
          <button class="acc-btn" onclick="toggleManual('photo')">
            ì‚¬ì§„ ì´¬ì˜ ê°€ì´ë“œ
            <span class="right"><span class="chip">ì—´ê¸°</span> â–¾</span>
          </button>
          <div class="acc-body" id="manual-photo" style="display:none;padding:0 12px 12px">
            <ul style="padding-left:16px;color:#111">
              <li style="margin-bottom:7px">ì¡°ëª… í™•ë³´</li>
              <li style="margin-bottom:7px">ì „ì²´ + ë””í…Œì¼ ì´¬ì˜</li>
              <li style="margin-bottom:7px">í”ë“¤ë¦¼ ì£¼ì˜</li>
              <li style="margin-bottom:7px">ì „/í›„ ê°™ì€ êµ¬ë„</li>
              <li>ê°œì¸ì •ë³´ ë…¸ì¶œ ì£¼ì˜</li>
            </ul>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div id="toast" class="toast"></div>

  <script>
    // ===== ì„¤ì • =====
    const GOOGLE_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbyOowo5Ptj2VcT3QTtfyajZp9SxkMeBt7BRdON-t6NuJlpqN17AGTNCdZJlc45eG5zk/exec';
    const FIXED_EMAIL = 'kjg2000914@naver.com';

    // ì„¹ì…˜/í•­ëª©
    const DATA = [
      { key:'bathroom', title:'1. í™”ì¥ì‹¤', items:['í™”ì¥ì‹¤'] },
      { key:'living', title:'2. ê±°ì‹¤', items:['ê±°ì‹¤'] },
      { key:'kitchen', title:'3. ì£¼ë°©', items:['ì£¼ë°©'] },
      { key:'bedroom', title:'4. ë°©', items:['ë°©'] },
      { key:'laundry', title:'5. ì„¸íƒì‹¤', items:['ì„¸íƒì‹¤'] },
      { key:'veranda', title:'6. ë² ë€ë‹¤', items:['ë² ë€ë‹¤'] },
      { key:'entrance', title:'7. í˜„ê´€', items:['í˜„ê´€'] },
    ];

    const photos = {}; // key -> dataURL
    let sig = {
      team: { drawing:false, lastX:0, lastY:0, canvas:null, ctx:null },
      customer: { drawing:false, lastX:0, lastY:0, canvas:null, ctx:null },
    };

    window.onload = () => {
      renderSections();
      initSignature('team', 'sigTeam');
      initSignature('customer', 'sigCustomer');
    };

    function showApp(name){
      document.getElementById('home').style.display='none';
      document.querySelectorAll('.app').forEach(a=>a.classList.remove('active'));
      document.getElementById(name+'-app').classList.add('active');
      window.scrollTo({top:0, behavior:'instant'});
      setTimeout(()=>{ resizeSig('team'); resizeSig('customer'); }, 200);
    }
    function goHome(){
      document.getElementById('home').style.display='flex';
      document.querySelectorAll('.app').forEach(a=>a.classList.remove('active'));
    }

    function renderSections(){
      const host = document.getElementById('sections');
      host.innerHTML = '';

      DATA.forEach((sec, sIdx)=>{
        const accId = `acc-${sec.key}`;
        const itemsHtml = sec.items.map((label, idx)=>{
          const id = `${sec.key}-${idx}`;
          return `
            <div class="item">
              <div class="item-name">${label}</div>
              <div class="photos">
                ${photoBoxHTML(`before-${id}`, 'ì‘ì—… ì „')}
                ${photoBoxHTML(`after-${id}`, 'ì‘ì—… í›„')}
              </div>
            </div>
          `;
        }).join('');

        host.innerHTML += `
          <div class="card" style="padding:0; overflow:hidden;">
            <div class="acc" id="${accId}" style="border:none;margin:0;border-radius:0">
              <button class="acc-btn" onclick="toggleAcc('${accId}')">
                ${sec.title}
                <span class="right"><span class="chip">ì—´ê¸°</span> â–¾</span>
              </button>
              <div class="acc-body">
                <div style="padding:0 12px 12px;">
                  ${itemsHtml}
                </div>
              </div>
            </div>
          </div>
        `;

        if(sIdx === 0) setTimeout(()=>toggleAcc(accId, true), 0);
      });
    }

    function toggleAcc(accId, forceOpen=false){
      const acc = document.getElementById(accId);
      if(!acc) return;
      if(forceOpen){ acc.classList.add('open'); return; }
      acc.classList.toggle('open');
    }

    function photoBoxHTML(key, label){
      const fileId = `file-${key}`;
      return `
        <div class="ph" id="${key}" onclick="openFile('${fileId}')">
          <img id="img-${key}" alt="preview"/>
          <div class="overlay">
            <div class="ico">ğŸ“·</div>
            <div class="t">${label}</div>
            <div class="s">í„°ì¹˜í•´ì„œ ì„ íƒ</div>
          </div>
          <input type="file" id="${fileId}" accept="image/*" style="display:none"
                 onchange="handlePhoto(this,'${key}')" />
        </div>
      `;
    }

    function openFile(id){
      const input = document.getElementById(id);
      if(input) input.click();
    }

    function handlePhoto(input, key){
      if(input.files && input.files[0]){
        const reader = new FileReader();
        reader.onload = (e)=>{
          photos[key] = e.target.result;
          const box = document.getElementById(key);
          const img = document.getElementById('img-'+key);
          box.classList.add('has');
          img.src = e.target.result;
        };
        reader.readAsDataURL(input.files[0]);
      }
    }

    // ===== ì„œëª… =====
    function initSignature(type, canvasId){
      const c = document.getElementById(canvasId);
      if(!c) return;
      sig[type].canvas = c;
      sig[type].ctx = c.getContext('2d');

      resizeSig(type);

      const getPos = (e)=>{
        const r = c.getBoundingClientRect();
        const t = (e.touches && e.touches[0]) ? e.touches[0] : null;
        const x = (t ? t.clientX : e.clientX) - r.left;
        const y = (t ? t.clientY : e.clientY) - r.top;
        return {x,y};
      };

      const down = (e)=>{
        e.preventDefault();
        sig[type].drawing = true;
        const p = getPos(e);
        sig[type].lastX = p.x;
        sig[type].lastY = p.y;
      };
      const move = (e)=>{
        if(!sig[type].drawing) return;
        e.preventDefault();
        const p = getPos(e);
        const ctx = sig[type].ctx;
        ctx.strokeStyle = '#000';
        ctx.lineWidth = 2;
        ctx.lineCap = 'round';
        ctx.lineJoin = 'round';
        ctx.beginPath();
        ctx.moveTo(sig[type].lastX, sig[type].lastY);
        ctx.lineTo(p.x, p.y);
        ctx.stroke();
        sig[type].lastX = p.x;
        sig[type].lastY = p.y;
      };
      const up = (e)=>{
        e.preventDefault();
        sig[type].drawing = false;
      };

      c.addEventListener('mousedown', down);
      c.addEventListener('mousemove', move);
      c.addEventListener('mouseup', up);
      c.addEventListener('mouseleave', up);

      c.addEventListener('touchstart', down, {passive:false});
      c.addEventListener('touchmove', move, {passive:false});
      c.addEventListener('touchend', up, {passive:false});

      window.addEventListener('resize', ()=>resizeSig(type));
    }

    function resizeSig(type){
      const c = sig[type].canvas;
      if(!c) return;
      const rect = c.getBoundingClientRect();
      c.width = Math.max(280, Math.floor(rect.width));
      c.height = (window.innerWidth <= 360) ? 170 : 190;
      const ctx = c.getContext('2d');
      ctx.fillStyle = '#fff';
      ctx.fillRect(0,0,c.width,c.height);
    }

    function clearSig(type){
      const c = sig[type].canvas;
      if(!c) return;
      const ctx = c.getContext('2d');
      ctx.clearRect(0,0,c.width,c.height);
      ctx.fillStyle = '#fff';
      ctx.fillRect(0,0,c.width,c.height);
    }

    function hasInk(canvas){
      if(!canvas) return false;
      const ctx = canvas.getContext('2d');
      const d = ctx.getImageData(0,0,canvas.width,canvas.height).data;
      for(let i=0;i<d.length;i+=4){
        const r=d[i], g=d[i+1], b=d[i+2], a=d[i+3];
        if(a !== 255) return true;
        if(!(r===255 && g===255 && b===255)) return true;
      }
      return false;
    }

    // ===== PDF =====
    async function makePDFBase64(){
      const el = document.getElementById('checklist-app');

      // ìº¡ì²˜ í’ˆì§ˆ/ìš©ëŸ‰ ë°¸ëŸ°ìŠ¤
      const canvas = await html2canvas(el, {
        scale: 2,
        useCORS: true,
        logging: false,
        backgroundColor: '#0b0b0c',
        windowWidth: document.documentElement.scrollWidth,
        windowHeight: document.documentElement.scrollHeight
      });

      const imgData = canvas.toDataURL('image/jpeg', 0.88);
      const { jsPDF } = window.jspdf;
      const pdf = new jsPDF('p','mm','a4');

      const pageW = 210, pageH = 297;
      const imgH = (canvas.height * pageW) / canvas.width;

      let left = imgH, pos = 0;
      pdf.addImage(imgData,'JPEG',0,pos,pageW,imgH,undefined,'FAST');
      left -= pageH;

      while(left > 0){
        pos = left - imgH;
        pdf.addPage();
        pdf.addImage(imgData,'JPEG',0,pos,pageW,imgH,undefined,'FAST');
        left -= pageH;
      }

      return { pdf, pdfBase64: pdf.output('dataurlstring').split(',')[1] };
    }

    async function downloadPDF(){
      const customer = document.getElementById('customerName').value.trim();
      if(!customer){ toast('ê³ ê°ëª…ì„ ì…ë ¥í•´ì£¼ì„¸ìš”'); return; }
      toast('PDF ìƒì„± ì¤‘...');
      try{
        const { pdf } = await makePDFBase64();
        const fileName = `ì²­ì†Œì²´í¬ë¦¬ìŠ¤íŠ¸_${customer}_${new Date().toISOString().split('T')[0]}.pdf`;
        pdf.save(fileName);
        toast('PDF ì €ì¥ ì™„ë£Œ!');
      }catch(e){
        console.error(e);
        toast('PDF ì˜¤ë¥˜');
      }
    }

    // ===== ZIP (ì‚¬ì§„ ì›ë³¸) =====
    async function makeZipBase64(customer){
      const zip = new JSZip();
      const folder = zip.folder(`photos_${customer}_${new Date().toISOString().split('T')[0]}`);

      // ì›ë³¸ ì´ë¯¸ì§€ dataURL -> íŒŒì¼ë¡œ ì €ì¥
      const keys = Object.keys(photos);
      for(const k of keys){
        const dataUrl = photos[k];
        const b64 = (dataUrl.split(',')[1] || '');
        folder.file(`${k}.jpg`, b64, { base64:true });
      }

      const blob = await zip.generateAsync({
        type:'blob',
        compression:'DEFLATE',
        compressionOptions:{ level:6 }
      });

      const b64zip = await blobToBase64(blob);
      return {
        zipBase64: b64zip,
        zipFileName: `ì‚¬ì§„ì••ì¶•_${customer}_${new Date().toISOString().split('T')[0]}.zip`,
        count: keys.length
      };
    }

    function blobToBase64(blob){
      return new Promise((resolve,reject)=>{
        const r = new FileReader();
        r.onload = ()=> resolve(String(r.result).split(',')[1]);
        r.onerror = reject;
        r.readAsDataURL(blob);
      });
    }

    // ===== ì œì¶œ =====
    async function submitAll(){
      const customer = document.getElementById('customerName').value.trim();
      const location = document.getElementById('location').value.trim();
      const worker = document.getElementById('worker').value.trim();
      const notes = document.getElementById('notes').value.trim();

      if(!customer || !location || !worker){
        toast('ê³ ê°ëª…/ìœ„ì¹˜/ë‹´ë‹¹ì ì…ë ¥ í•„ìš”');
        return;
      }

      if(!hasInk(sig.team.canvas)){ toast('íŒ€ì¥ ì„œëª… í•„ìš”'); return; }
      if(!hasInk(sig.customer.canvas)){ toast('ê³ ê°/ëŒ€ë¦¬ì¸ ì„œëª… í•„ìš”'); return; }

      try{
        toast('PDF ìƒì„± ì¤‘...');
        const { pdfBase64 } = await makePDFBase64();
        const pdfName = `ì²­ì†Œì²´í¬ë¦¬ìŠ¤íŠ¸_${customer}_${new Date().toISOString().split('T')[0]}.pdf`;

        toast('ì‚¬ì§„ ì••ì¶• ì¤‘...');
        const { zipBase64, zipFileName, count } = await makeZipBase64(customer);

        // ì‚¬ì§„ì´ 0ì¥ì´ì–´ë„ ì œì¶œì€ ë˜ê²Œ (ì›í•˜ë©´ ì—¬ê¸°ì„œ ë§‰ì„ ìˆ˜ë„ ìˆìŒ)
        // if(count === 0){ toast('ì‚¬ì§„ì´ ì—†ìŠµë‹ˆë‹¤. ì‚¬ì§„ ì²¨ë¶€ í›„ ì œì¶œí•´ì£¼ì„¸ìš”'); return; }

        toast('ë©”ì¼ ì „ì†¡ ì¤‘...');

        const payload = {
          to_email: FIXED_EMAIL,
          customer_name: customer,
          location,
          worker,
          notes,
          date: new Date().toLocaleDateString('ko-KR'),
          pdf_base64: pdfBase64,
          pdf_filename: pdfName,
          zip_base64: zipBase64,
          zip_filename: zipFileName,
          photo_count: count
        };

        // âœ… Apps ScriptëŠ” content-type ì´ìŠˆê°€ ìì£¼ ìˆì–´ì„œ text/plainì´ ì•ˆì •ì 
        await fetch(GOOGLE_SCRIPT_URL, {
          method:'POST',
          mode:'no-cors',
          headers:{ 'Content-Type':'text/plain;charset=utf-8' },
          body: JSON.stringify(payload)
        });

        toast(`ì œì¶œ ì™„ë£Œ! (${FIXED_EMAIL})`);
        setTimeout(()=>resetAll(false), 700);

      }catch(e){
        console.error(e);
        toast('ì˜¤ë¥˜ ë°œìƒ: ë‹¤ì‹œ ì‹œë„');
      }
    }

    function resetAll(showMsg){
      document.getElementById('customerName').value='';
      document.getElementById('location').value='';
      document.getElementById('worker').value='';
      document.getElementById('notes').value='';

      // ì‚¬ì§„ ì´ˆê¸°í™”
      Object.keys(photos).forEach(k=>delete photos[k]);
      document.querySelectorAll('.ph').forEach(p=>p.classList.remove('has'));
      document.querySelectorAll('.ph img').forEach(img=>img.src='');
      document.querySelectorAll('input[type=file]').forEach(i=>i.value='');

      // ì„œëª… ì´ˆê¸°í™”
      clearSig('team');
      clearSig('customer');

      // ì²« ì„¹ì…˜ ì˜¤í”ˆ
      document.querySelectorAll('.acc').forEach(a=>a.classList.remove('open'));
      const first = document.getElementById('acc-bathroom');
      if(first) first.classList.add('open');

      if(showMsg) toast('ì´ˆê¸°í™” ì™„ë£Œ!');
      window.scrollTo({top:0, behavior:'instant'});
    }

    function toggleManual(type){
      const el = document.getElementById('manual-'+type);
      if(!el) return;
      el.style.display = (el.style.display === 'none' || !el.style.display) ? 'block' : 'none';
    }

    // í† ìŠ¤íŠ¸
    let toastTimer;
    function toast(msg){
      const t = document.getElementById('toast');
      t.textContent = msg;
      t.classList.add('show');
      clearTimeout(toastTimer);
      toastTimer = setTimeout(()=>t.classList.remove('show'), 2400);
    }
  </script>
</body>
</html>
